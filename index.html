<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woodland Work Finch for Lele+Flora</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #f5f5dc 0%, #f0f0e8 100%);
            min-height: 100vh;
            padding: 20px;
            color: #5a5a5a;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
        }

        .tasks-panel {
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #8b4513;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.8em;
        }

        .project-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .project-tab {
            padding: 8px 16px;
            background: rgba(212, 181, 160, 0.3);
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .project-tab.active {
            background: #d4b5a0;
            color: #5a5a5a;
            border-color: #8b4513;
        }

        .project-tab:hover {
            background: rgba(212, 181, 160, 0.5);
        }

        .project-progress {
            font-size: 10px;
            position: absolute;
            top: -5px;
            right: -5px;
            background: #8b4513;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .task-input-section {
            margin-bottom: 25px;
        }

        .section-divider {
            display: flex;
            justify-content: center;
            margin: 15px 0 10px 0;
        }

        .section-help {
            font-size: 12px;
            color: #8b4513;
            font-style: italic;
            background: rgba(212, 181, 160, 0.3);
            padding: 6px 12px;
            border-radius: 12px;
        }

        .task-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .task-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: white;
        }

        .task-input-row-2 {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 10px;
        }

        .input-row-top {
            display: flex;
            gap: 10px;
        }

        .input-row-bottom {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .project-input-container {
            position: relative;
            flex: 1;
            min-width: 140px;
        }

        .project-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: white;
        }

        .subcategory-container {
            width: 100%;
        }

        .subcategory-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            background: #fafafa;
            color: #666;
        }

        .subcategory-input:focus {
            border-color: #d4b5a0;
            background: white;
            outline: none;
        }

        .priority-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .priority-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            min-width: 90px;
            flex: 1;
        }

        .priority-btn:hover {
            background: rgba(212, 181, 160, 0.3);
        }

        .priority-btn.active {
            background: #d4b5a0;
            border-color: #8b4513;
            color: #5a5a5a;
        }

        .priority-emoji {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .priority-label {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
            line-height: 1.1;
        }

        .points-slider-container {
            min-width: 160px;
            flex: 1;
            position: relative;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #8b4513;
            font-weight: 500;
        }

        .effort-display {
            font-size: 11px;
            color: #999;
            font-weight: normal;
        }

        .points-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #e8f5e8, #fff3e0, #ffebee);
            outline: none;
            appearance: none;
            cursor: pointer;
        }

        .points-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #8b4513;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .points-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #8b4513;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 9px;
            color: #999;
        }

        .effort-tooltip {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .effort-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .points-slider-container:hover .effort-tooltip {
            opacity: 1;
        }

        .add-btn {
            padding: 12px 20px;
            background: #8b4513;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-btn:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }

        .tasks-container {
            flex: 1;
            overflow-y: auto;
        }

        .task-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            border-left: 5px solid #d4b5a0;
        }

        .task-item.must-do {
            border-left: 5px solid #d32f2f;
        }

        .task-item.nice-to-do {
            border-left: 5px solid #2e7d32;
        }

        .task-item.stretch-goal {
            border-left: 5px solid #1976d2;
        }

        .task-item:hover {
            border-color: #d4b5a0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .task-item.completed {
            opacity: 0.6;
            background: #f8f8f0;
        }

        .task-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d4b5a0;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-checkbox.checked {
            background: #8b4513;
            border-color: #8b4513;
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            position: absolute;
            top: -2px;
            left: 3px;
            font-size: 14px;
            font-weight: bold;
        }

        .task-details {
            flex: 1;
        }

        .task-text {
            font-size: 16px;
            line-height: 1.4;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #999;
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .task-project {
            display: inline-block;
            background: #d4b5a0;
            color: #5a5a5a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .task-priority {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-must-do {
            background: #ffebee;
            color: #d32f2f;
        }

        .priority-nice-to-do {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .priority-stretch-goal {
            background: #e3f2fd;
            color: #1976d2;
        }

        .task-points {
            background: #fff3e0;
            color: #f57c00;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .task-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-item:hover .task-actions {
            opacity: 1;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .edit-btn:hover {
            background: #e8e8e8;
        }

        .delete-btn:hover {
            background: #ffe6e6;
            color: #d32f2f;
        }

        .buddy-panel {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .weather-section {
            width: 100%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .weather-display {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .weather-text {
            font-size: 16px;
            color: #8b4513;
            font-weight: 500;
        }

        .weather-help {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }

        .buddy-container {
            margin: 30px 0;
            position: relative;
        }

        .forest-creature {
            font-size: 120px;
            transition: all 0.5s ease;
            cursor: pointer;
            user-select: none;
        }

        .forest-creature:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .forest-creature.happy {
            animation: bounce 0.6s ease;
        }

        .animal-visitor {
            position: absolute;
            font-size: 40px;
            animation: float 3s ease-in-out infinite;
            pointer-events: none;
        }

        .visitor-1 { top: -20px; right: 20px; animation-delay: 0s; }
        .visitor-2 { top: 30px; left: -20px; animation-delay: 1s; }
        .visitor-3 { bottom: -20px; right: -10px; animation-delay: 2s; }

        .visitor-help {
            font-size: 12px;
            color: #8b4513;
            margin-top: 10px;
            font-style: italic;
            text-align: center;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .stats {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            width: 100%;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .stat-label {
            font-weight: 500;
            color: #8b4513;
        }

        .stat-value {
            font-weight: 600;
            color: #5a5a5a;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e8e8e8;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b4513, #d4b5a0);
            transition: width 0.5s ease;
        }

        .weekly-summary {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            width: 100%;
        }

        .week-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .week-day {
            text-align: center;
            font-size: 12px;
            color: #8b4513;
        }

        .day-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px 0;
            font-weight: 600;
            font-size: 10px;
        }

        .day-circle.active {
            background: #8b4513;
            color: white;
        }

        .day-circle.partial {
            background: #d4b5a0;
            color: white;
        }

        .weekly-help {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            font-style: italic;
        }

        .motivational-message {
            margin-top: 20px;
            padding: 15px;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 12px;
            font-style: italic;
            color: #8b4513;
            border-left: 4px solid #8b4513;
            width: 100%;
        }

        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .edit-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .edit-modal h3 {
            color: #8b4513;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .edit-modal input, .edit-modal select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            margin-bottom: 15px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
        }

        .edit-project-container input:last-child {
            margin-top: 8px;
        }

        .edit-modal-row {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .edit-priority-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .edit-points-container {
            min-width: 150px;
            position: relative;
        }

        .edit-points-container:hover .effort-tooltip {
            opacity: 1;
        }

        .edit-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .save-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
        }

        .save-btn {
            background: #8b4513;
            color: white;
        }

        .cancel-btn {
            background: #e8e8e8;
            color: #5a5a5a;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            width: 100%;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: #8b4513;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .task-input-row, .input-row-top, .input-row-bottom {
                flex-direction: column;
            }
            
            .project-input-container, .priority-buttons, .points-slider-container {
                width: 100%;
            }

            .priority-buttons {
                justify-content: center;
            }

            .priority-btn {
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tasks Panel -->
        <div class="panel tasks-panel">
            <h1>üìã My Tasks</h1>
            
            <div class="project-tabs" id="projectTabs">
                <div class="project-tab active" onclick="filterByProject('')">
                    üåç All Categories
                    <div class="project-progress" id="allProgress">0</div>
                </div>
            </div>

            <div class="task-input-section">
                <div class="task-input-row">
                    <input type="text" id="taskInput" class="task-input" placeholder="‚ú® What adventure shall we tackle today?" maxlength="100">
                </div>
                <div class="section-divider">
                    <span class="section-help">üóÇÔ∏è Group similar tasks together!</span>
                </div>
                <div class="task-input-row-2">
                    <div class="project-input-container">
                        <input type="text" id="projectInput" class="project-input" placeholder="üóÇÔ∏è Category (or type your own!)" maxlength="20" list="categoryDatalist">
                        <datalist id="categoryDatalist">
                            <option value="Admin">
                            <option value="Communication">
                            <option value="Development">
                            <option value="Meeting Prep">
                            <option value="Personal">
                            <option value="Projects">
                        </datalist>
                        <div class="subcategory-container">
                            <input type="text" id="subcategoryInput" class="subcategory-input" placeholder="üìÇ Sub-category (optional)" maxlength="20" list="subcategoryDatalist">
                            <datalist id="subcategoryDatalist"></datalist>
                        </div>
                    </div>
                    <div class="priority-buttons" id="priorityButtons">
                        <button type="button" class="priority-btn active" data-priority="must-do">
                            <span class="priority-emoji">üî•</span>
                            <span class="priority-label">Must-Do</span>
                        </button>
                        <button type="button" class="priority-btn" data-priority="nice-to-do">
                            <span class="priority-emoji">‚≠ê</span>
                            <span class="priority-label">Nice-to-Do</span>
                        </button>
                        <button type="button" class="priority-btn" data-priority="stretch-goal">
                            <span class="priority-emoji">üöÄ</span>
                            <span class="priority-label">Stretch Goal</span>
                        </button>
                    </div>
                    <div class="points-slider-container">
                        <div class="slider-label">
                            <span>‚ö° Effort Level</span>
                            <span class="effort-display" id="effortDisplay">Quick Task</span>
                        </div>
                        <input type="range" id="pointsSlider" class="points-slider" min="1" max="10" value="1">
                        <div class="slider-markers">
                            <span>1</span><span>5</span><span>10</span>
                        </div>
                        <div class="effort-tooltip" id="effortTooltip">
                            <div class="tooltip-content">
                                <strong>Time Guide:</strong><br>
                                1-2 pts: Quick (5-15 min)<br>
                                3-4 pts: Medium (30-60 min)<br>
                                5-7 pts: Big (2-4 hours)<br>
                                8-10 pts: Epic (full day+)
                            </div>
                        </div>
                    </div>
                </div>
                <button id="addTaskBtn" class="add-btn">üå± Plant Your Task</button>
            </div>

            <div class="tasks-container">
                <div id="tasksList"></div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    No tasks yet! Add some tasks to help your forest companion grow! üå±
                </div>
            </div>
        </div>

        <!-- Productivity Buddy Panel -->
        <div class="panel buddy-panel">
            <h1>ü¶ä Productivity Buddy</h1>
            
            <div class="weather-section">
                <div class="weather-display" id="weatherEmoji">‚òÄÔ∏è</div>
                <div class="weather-text" id="weatherText">Perfect productivity weather!</div>
                <div class="weather-help">üå§Ô∏è Weather changes based on your weekly completion rate</div>
            </div>
            
            <div class="buddy-container">
                <div id="forestCreature" class="forest-creature">üå∞</div>
                <div id="creatureName" style="font-size: 18px; font-weight: 600; color: #8b4513; margin-top: 10px;">Forest Seed</div>
                
                <!-- Animal visitors -->
                <div id="animalVisitors"></div>
                <div class="visitor-help" id="visitorHelp" style="display: none;">
                    üéâ Forest friends visit when you complete all must-do tasks!
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">Level:</span>
                    <span class="stat-value" id="level">1</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Points:</span>
                    <span class="stat-value" id="totalPoints">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tasks Completed:</span>
                    <span class="stat-value" id="completedCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Must-Do Streak:</span>
                    <span class="stat-value" id="mustDoStreak">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Experience:</span>
                    <span class="stat-value"><span id="currentXP">0</span>/<span id="nextLevelXP">25</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="weekly-summary">
                <h3 style="color: #8b4513; margin-bottom: 15px; font-size: 1.1em;">This Week</h3>
                <div class="week-progress" id="weekProgress"></div>
                <div style="font-size: 14px; color: #5a5a5a; margin-top: 10px;">
                    <strong id="weeklyMustDoComplete">0</strong> of <strong id="weeklyMustDoTotal">0</strong> must-do tasks completed
                </div>
                <div class="weekly-help">
                    Complete 3+ tasks per day to fill the circles! üéØ
                </div>
            </div>

            <div id="motivationalMessage" class="motivational-message">
                Welcome! Complete tasks to help your forest companion grow from a seed! üå±
            </div>

            <div class="export-section">
                <h3 style="color: #8b4513; margin-bottom: 15px; font-size: 1.2em;">Sync Your Tasks</h3>
                <button class="export-btn" onclick="exportToJSON()">üíæ Export Tasks</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importFromJSON()">
                <button class="export-btn" onclick="document.getElementById('importFile').click()">üì• Import Tasks</button>
                <button class="export-btn" onclick="exportToCSV()">üìä Export to CSV</button>
                <button class="export-btn" onclick="exportToMarkdown()">üìù Export to Markdown</button>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                    Export/Import JSON to sync between devices. CSV/Markdown for other tools.
                </p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content">
            <h3>Edit Task</h3>
            <input type="text" id="editTaskText" placeholder="Task description">
            <input type="text" id="editTaskProject" placeholder="Project">
            <div class="edit-modal-row">
                <select id="editTaskPriority">
                    <option value="must-do">Must-Do</option>
                    <option value="nice-to-do">Nice-to-Do</option>
                    <option value="stretch-goal">Stretch Goal</option>
                </select>
                <input type="number" id="editTaskPoints" placeholder="Points" min="1" max="10">
            </div>
            <div class="edit-modal-actions">
                <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
                <button class="save-btn" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // App State
        let tasks = JSON.parse(localStorage.getItem('forestTasks')) || [];
        let currentTaskId = parseInt(localStorage.getItem('currentTaskId')) || 1;
        let completedTasksCount = parseInt(localStorage.getItem('completedTasksCount')) || 0;
        let mustDoStreak = parseInt(localStorage.getItem('mustDoStreak')) || 0;
        let level = parseInt(localStorage.getItem('level')) || 1;
        let totalPoints = parseInt(localStorage.getItem('totalPoints')) || 0;
        let categorySubcategories = JSON.parse(localStorage.getItem('categorySubcategories')) || {};
        let editingTaskId = null;
        let currentProjectFilter = '';

        // Forest creature evolution stages
        const creatureStages = [
            { emoji: 'üå∞', name: 'Forest Seed', minLevel: 1 },
            { emoji: 'ü¶ä', name: 'Fox Kit', minLevel: 3 },
            { emoji: 'üê∫', name: 'Young Wolf', minLevel: 6 },
            { emoji: 'ü¶å', name: 'Forest Deer', minLevel: 10 },
            { emoji: 'üßö‚Äç‚ôÄÔ∏è', name: 'Forest Guardian', minLevel: 15 },
            { emoji: 'üëëüå≤', name: 'Forest Ruler', minLevel: 25 }
        ];

        // Weather patterns
        const weatherPatterns = [
            { emoji: '‚òÄÔ∏è', text: 'Perfect productivity weather!', condition: 'high' },
            { emoji: '‚õÖ', text: 'Partly cloudy but getting things done!', condition: 'medium' },
            { emoji: 'üåßÔ∏è', text: 'Rainy day - time to focus indoors', condition: 'low' },
            { emoji: '‚ùÑÔ∏è', text: 'Winter productivity mode', condition: 'very-low' },
            { emoji: 'üåà', text: 'Rainbow after the storm - great work!', condition: 'excellent' }
        ];

        // Animal visitors
        const animalVisitors = ['ü¶ã', 'üêøÔ∏è', 'ü¶â', 'üê∞', 'ü¶î', 'ü¶ù', 'üêª'];

        // Motivational messages
        const messages = [
            "Your forest friend is getting stronger! üí™",
            "Great job! Keep up the momentum! üöÄ",
            "You're on fire! Your companion is proud! üî•",
            "Fantastic progress! Level up! ‚≠ê",
            "Your productivity is growing like a mighty forest! üå≤",
            "Howl! Another task conquered! ü¶ä",
            "Your forest companion is evolving beautifully! üåü",
            "Keep nurturing your companion with completed tasks! üçÉ"
        ];

        // Initialize app
        function init() {
            updateUI();
            updateProjectTabs();
            updateWeather();
            updateAnimalVisitors();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Task input
            document.getElementById('addTaskBtn').addEventListener('click', addTask);
            document.getElementById('taskInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addTask();
            });
            document.getElementById('forestCreature').addEventListener('click', petCreature);

            // Category input - update subcategory suggestions when category changes
            document.getElementById('projectInput').addEventListener('input', function() {
                updateSubcategorySuggestions(this.value, 'subcategoryDatalist');
            });

            document.getElementById('editTaskProject').addEventListener('input', function() {
                updateSubcategorySuggestions(this.value, 'editSubcategoryDatalist');
            });

            // Priority buttons - use event delegation to handle dynamically created buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.priority-btn')) {
                    const btn = e.target.closest('.priority-btn');
                    const container = btn.closest('.priority-buttons') || btn.closest('.edit-priority-buttons');
                    container.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
                
                // Handle edit buttons with data attributes
                if (e.target.classList.contains('edit-btn') || e.target.closest('.edit-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const editBtn = e.target.classList.contains('edit-btn') ? e.target : e.target.closest('.edit-btn');
                    const taskId = parseInt(editBtn.getAttribute('data-task-id'));
                    if (taskId) {
                        editTask(taskId);
                    }
                }
                
                // Handle delete buttons with data attributes
                if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const deleteBtn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
                    const taskId = parseInt(deleteBtn.getAttribute('data-task-id'));
                    if (taskId && confirm('Delete this task?')) {
                        deleteTask(taskId);
                    }
                }
            });

            // Points slider
            const pointsSlider = document.getElementById('pointsSlider');
            const effortDisplay = document.getElementById('effortDisplay');
            
            pointsSlider.addEventListener('input', function() {
                updateEffortDisplay(this.value, effortDisplay);
            });

            // Edit modal points slider
            const editPointsSlider = document.getElementById('editPointsSlider');
            const editEffortDisplay = document.getElementById('editEffortDisplay');
            
            editPointsSlider.addEventListener('input', function() {
                updateEffortDisplay(this.value, editEffortDisplay);
            });
        }

        function updateSubcategorySuggestions(category, datalistId) {
            const datalist = document.getElementById(datalistId);
            datalist.innerHTML = '';
            
            if (category && categorySubcategories[category]) {
                categorySubcategories[category].forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    datalist.appendChild(option);
                });
            }
        }

        function learnCategorySubcategory(category, subcategory) {
            if (!category || !subcategory) return;
            
            if (!categorySubcategories[category]) {
                categorySubcategories[category] = [];
            }
            
            // Add subcategory if it doesn't exist
            if (!categorySubcategories[category].includes(subcategory)) {
                categorySubcategories[category].push(subcategory);
                // Keep subcategories sorted
                categorySubcategories[category].sort();
            }
        }

        function updateEffortDisplay(value, displayElement) {
            const effortLevels = {
                1: 'Quick Task',
                2: 'Quick Task',
                3: 'Medium Task', 
                4: 'Medium Task',
                5: 'Big Task',
                6: 'Big Task',
                7: 'Big Task',
                8: 'Major Project',
                9: 'Major Project',
                10: 'Epic Quest'
            };
            displayElement.textContent = effortLevels[value] || 'Quick Task';
        }

        function saveToStorage() {
            localStorage.setItem('forestTasks', JSON.stringify(tasks));
            localStorage.setItem('currentTaskId', currentTaskId.toString());
            localStorage.setItem('completedTasksCount', completedTasksCount.toString());
            localStorage.setItem('mustDoStreak', mustDoStreak.toString());
            localStorage.setItem('level', level.toString());
            localStorage.setItem('totalPoints', totalPoints.toString());
            localStorage.setItem('categorySubcategories', JSON.stringify(categorySubcategories));
        }

        function addTask() {
            const taskText = document.getElementById('taskInput').value.trim();
            let project = document.getElementById('projectInput').value.trim() || 'General';
            const subcategory = document.getElementById('subcategoryInput').value.trim();
            
            // Learn the category-subcategory relationship
            if (subcategory) {
                learnCategorySubcategory(project, subcategory);
                project = `${project} > ${subcategory}`;
            }
            
            // Get selected priority from active button
            const activePriorityBtn = document.querySelector('.priority-buttons .priority-btn.active');
            const priority = activePriorityBtn ? activePriorityBtn.dataset.priority : 'must-do';
            
            const points = parseInt(document.getElementById('pointsSlider').value) || 1;
            
            if (!taskText) return;

            const task = {
                id: currentTaskId++,
                text: taskText,
                project: project,
                priority: priority,
                points: points,
                completed: false,
                createdAt: new Date().toISOString(),
                completedAt: null
            };

            tasks.push(task);
            
            // Clear inputs and reset to defaults
            document.getElementById('taskInput').value = '';
            document.getElementById('projectInput').value = '';
            document.getElementById('subcategoryInput').value = '';
            document.getElementById('pointsSlider').value = 1;
            updateEffortDisplay(1, document.getElementById('effortDisplay'));
            
            // Reset priority buttons to must-do
            document.querySelectorAll('.priority-buttons .priority-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.priority === 'must-do') {
                    btn.classList.add('active');
                }
            });
            
            saveToStorage();
            updateUI();
            updateProjectTabs();
        }

        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const wasCompleted = task.completed;
            task.completed = !task.completed;
            task.completedAt = task.completed ? new Date().toISOString() : null;

            if (!wasCompleted && task.completed) {
                // Task completed
                completedTasksCount++;
                totalPoints += task.points;
                
                // Update must-do streak
                if (task.priority === 'must-do') {
                    updateMustDoStreak();
                }
                
                // Check for level up
                const xpNeeded = getXPForLevel(level + 1);
                if (totalPoints >= xpNeeded) {
                    level++;
                    showMotivationalMessage();
                    animateCreature();
                }
                
                animateCreature();
            } else if (wasCompleted && !task.completed) {
                // Task uncompleted
                completedTasksCount--;
                totalPoints = Math.max(0, totalPoints - task.points);
                
                // Recalculate must-do streak
                updateMustDoStreak();
                
                // Check for level down
                if (totalPoints < getXPForLevel(level)) {
                    level = Math.max(1, level - 1);
                }
            }

            saveToStorage();
            updateUI();
            updateWeather();
            updateAnimalVisitors();
        }

        function updateMustDoStreak() {
            // Get this week's must-do tasks
            const thisWeekStart = getWeekStart();
            const thisWeekTasks = tasks.filter(task => {
                return task.priority === 'must-do' && 
                       new Date(task.createdAt) >= thisWeekStart;
            });
            
            const completedThisWeek = thisWeekTasks.filter(task => task.completed);
            
            if (thisWeekTasks.length === 0) {
                mustDoStreak = 0;
            } else if (completedThisWeek.length === thisWeekTasks.length) {
                // All must-dos completed this week
                mustDoStreak++;
            } else {
                mustDoStreak = 0;
            }
        }

        function deleteTask(taskId) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = tasks[taskIndex];
            if (task.completed) {
                completedTasksCount--;
                totalPoints = Math.max(0, totalPoints - task.points);
                updateMustDoStreak();
                
                if (totalPoints < getXPForLevel(level)) {
                    level = Math.max(1, level - 1);
                }
            }

            tasks.splice(taskIndex, 1);
            saveToStorage();
            updateUI();
            updateProjectTabs();
            updateWeather();
            updateAnimalVisitors();
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            
            // Show modal first
            document.getElementById('editModal').style.display = 'flex';
            
            // Then populate fields (wait a tiny bit for modal to render)
            setTimeout(() => {
                document.getElementById('editTaskText').value = task.text;
                
                // Split project and subcategory
                const projectParts = task.project.split(' > ');
                document.getElementById('editTaskProject').value = projectParts[0] || '';
                
                const subcategoryField = document.getElementById('editTaskSubcategory');
                if (subcategoryField) {
                    subcategoryField.value = projectParts[1] || '';
                }
                
                // Set priority buttons
                document.querySelectorAll('.edit-priority-buttons .priority-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.priority === task.priority) {
                        btn.classList.add('active');
                    }
                });
                
                // Set points slider
                const editSlider = document.getElementById('editPointsSlider');
                if (editSlider) {
                    editSlider.value = task.points;
                    updateEffortDisplay(task.points, document.getElementById('editEffortDisplay'));
                }
            }, 50);
        }

        function saveEdit() {
            const task = tasks.find(t => t.id === editingTaskId);
            if (!task) return;

            const newText = document.getElementById('editTaskText').value.trim();
            let newProject = document.getElementById('editTaskProject').value.trim() || 'General';
            const newSubcategory = document.getElementById('editTaskSubcategory').value.trim();
            
            // Learn the category-subcategory relationship
            if (newSubcategory) {
                learnCategorySubcategory(newProject, newSubcategory);
                newProject = `${newProject} > ${newSubcategory}`;
            }
            
            // Get selected priority from active button
            const activeEditBtn = document.querySelector('.edit-priority-buttons .priority-btn.active');
            const newPriority = activeEditBtn ? activeEditBtn.dataset.priority : 'must-do';
            
            const newPoints = parseInt(document.getElementById('editPointsSlider').value) || 1;

            if (!newText) return;

            // Update points if task is completed
            if (task.completed) {
                totalPoints = totalPoints - task.points + newPoints;
            }

            task.text = newText;
            task.project = newProject;
            task.priority = newPriority;
            task.points = newPoints;

            cancelEdit();
            saveToStorage();
            updateUI();
            updateProjectTabs();
        }

        function cancelEdit() {
            document.getElementById('editModal').style.display = 'none';
            editingTaskId = null;
        }

        function filterByProject(project) {
            currentProjectFilter = project;
            updateUI();
            
            // Update active tab
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function getXPForLevel(targetLevel) {
            return targetLevel * 25;
        }

        function getCurrentCreatureStage() {
            for (let i = creatureStages.length - 1; i >= 0; i--) {
                if (level >= creatureStages[i].minLevel) {
                    return creatureStages[i];
                }
            }
            return creatureStages[0];
        }

        function getWeekStart() {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        function updateWeather() {
            const thisWeekStart = getWeekStart();
            const thisWeekTasks = tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                return taskDate >= thisWeekStart;
            });

            const completedThisWeek = thisWeekTasks.filter(task => task.completed).length;
            const totalThisWeek = thisWeekTasks.length;
            
            let weatherIndex;
            if (totalThisWeek === 0) {
                weatherIndex = 1; // Partly cloudy
            } else {
                const completionRate = completedThisWeek / totalThisWeek;
                if (completionRate >= 0.9) weatherIndex = 4; // Rainbow
                else if (completionRate >= 0.7) weatherIndex = 0; // Sunny
                else if (completionRate >= 0.4) weatherIndex = 1; // Partly cloudy
                else if (completionRate >= 0.2) weatherIndex = 2; // Rainy
                else weatherIndex = 3; // Winter
            }

            const weather = weatherPatterns[weatherIndex];
            document.getElementById('weatherEmoji').textContent = weather.emoji;
            document.getElementById('weatherText').textContent = weather.text;
        }

        function updateAnimalVisitors() {
            const thisWeekStart = getWeekStart();
            const mustDoTasks = tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                return task.priority === 'must-do' && taskDate >= thisWeekStart;
            });
            
            const completedMustDos = mustDoTasks.filter(task => task.completed);
            const visitorsContainer = document.getElementById('animalVisitors');
            const visitorHelp = document.getElementById('visitorHelp');
            
            if (mustDoTasks.length > 0 && completedMustDos.length === mustDoTasks.length) {
                // All must-dos completed - show visitors!
                const numVisitors = Math.min(3, Math.floor(completedMustDos.length / 2) + 1);
                visitorsContainer.innerHTML = '';
                
                for (let i = 0; i < numVisitors; i++) {
                    const visitor = document.createElement('div');
                    visitor.className = `animal-visitor visitor-${i + 1}`;
                    visitor.textContent = animalVisitors[Math.floor(Math.random() * animalVisitors.length)];
                    visitorsContainer.appendChild(visitor);
                }
                
                visitorHelp.style.display = 'block';
                visitorHelp.textContent = 'üéâ Amazing! You completed all must-do tasks this week!';
            } else if (mustDoTasks.length > 0) {
                visitorsContainer.innerHTML = '';
                visitorHelp.style.display = 'block';
                visitorHelp.textContent = `üéØ Complete ${mustDoTasks.length - completedMustDos.length} more must-do tasks for forest visitors!`;
            } else {
                visitorsContainer.innerHTML = '';
                visitorHelp.style.display = 'none';
            }
        }

        function updateWeeklyProgress() {
            const weekProgress = document.getElementById('weekProgress');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const thisWeekStart = getWeekStart();
            
            weekProgress.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(thisWeekStart);
                dayDate.setDate(thisWeekStart.getDate() + i);
                
                const dayTasks = tasks.filter(task => {
                    const taskDate = new Date(task.completedAt || task.createdAt);
                    return taskDate.toDateString() === dayDate.toDateString() && task.completed;
                });
                
                const dayElement = document.createElement('div');
                dayElement.className = 'week-day';
                dayElement.innerHTML = `
                    <div>${days[i]}</div>
                    <div class="day-circle ${dayTasks.length >= 3 ? 'active' : dayTasks.length > 0 ? 'partial' : ''}">${dayTasks.length}</div>
                `;
                weekProgress.appendChild(dayElement);
            }
            
            // Update must-do progress
            const thisWeekMustDos = tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                return task.priority === 'must-do' && taskDate >= thisWeekStart;
            });
            const completedMustDos = thisWeekMustDos.filter(task => task.completed);
            
            document.getElementById('weeklyMustDoComplete').textContent = completedMustDos.length;
            document.getElementById('weeklyMustDoTotal').textContent = thisWeekMustDos.length;
        }

        function updateUI() {
            updateTasksList();
            updateBuddy();
            updateStats();
            updateWeeklyProgress();
        }

        function updateTasksList() {
            const tasksList = document.getElementById('tasksList');
            const emptyState = document.getElementById('emptyState');
            
            const filteredTasks = currentProjectFilter ? 
                tasks.filter(task => task.project === currentProjectFilter) : 
                tasks;

            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tasksList.innerHTML = filteredTasks.map(task => `
                <div class="task-item ${task.completed ? 'completed' : ''} ${task.priority}" data-task-id="${task.id}">
                    <div class="task-content">
                        <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                             onclick="toggleTask(${task.id})"></div>
                        <div class="task-details">
                            <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                            <div class="task-meta">
                                <div class="task-project">${task.project}</div>
                                <div class="task-priority priority-${task.priority}">${task.priority.replace('-', ' ')}</div>
                                <div class="task-points">${task.points} pts</div>
                            </div>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="edit-btn" data-task-id="${task.id}">‚úèÔ∏è</button>
                        <button class="delete-btn" data-task-id="${task.id}">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function updateBuddy() {
            const forestCreature = document.getElementById('forestCreature');
            const creatureName = document.getElementById('creatureName');
            const currentStage = getCurrentCreatureStage();
            
            forestCreature.textContent = currentStage.emoji;
            creatureName.textContent = currentStage.name;
        }

        function updateStats() {
            document.getElementById('level').textContent = level;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('completedCount').textContent = completedTasksCount;
            document.getElementById('mustDoStreak').textContent = mustDoStreak;
            document.getElementById('currentXP').textContent = totalPoints;
            document.getElementById('nextLevelXP').textContent = getXPForLevel(level + 1);
            
            const progressPercent = Math.min(100, (totalPoints / getXPForLevel(level + 1)) * 100);
            document.getElementById('progressFill').style.width = progressPercent + '%';
        }

        function updateProjectTabs() {
            const projectTabs = document.getElementById('projectTabs');
            const projects = [...new Set(tasks.map(task => task.project))].sort();
            
            // Clear existing tabs except "All Categories"
            projectTabs.innerHTML = `
                <div class="project-tab ${currentProjectFilter === '' ? 'active' : ''}" onclick="filterByProject('')">
                    üåç All Categories
                    <div class="project-progress" id="allProgress">0</div>
                </div>
            `;
            
            projects.forEach(project => {
                const projectTasks = tasks.filter(task => task.project === project);
                const completedTasks = projectTasks.filter(task => task.completed);
                const progressPercent = projectTasks.length > 0 ? Math.round((completedTasks.length / projectTasks.length) * 100) : 0;
                
                const tab = document.createElement('div');
                tab.className = `project-tab ${currentProjectFilter === project ? 'active' : ''}`;
                tab.onclick = () => filterByProject(project);
                tab.innerHTML = `
                    ${project}
                    <div class="project-progress">${progressPercent}%</div>
                `;
                projectTabs.appendChild(tab);
            });
            
            // Update all projects progress
            const allCompleted = tasks.filter(task => task.completed).length;
            const allProgress = tasks.length > 0 ? Math.round((allCompleted / tasks.length) * 100) : 0;
            document.getElementById('allProgress').textContent = allProgress + '%';
        }

        function animateCreature() {
            const creature = document.getElementById('forestCreature');
            creature.classList.add('happy');
            setTimeout(() => creature.classList.remove('happy'), 600);
        }

        function petCreature() {
            animateCreature();
            showMotivationalMessage();
        }

        function showMotivationalMessage() {
            const messageEl = document.getElementById('motivationalMessage');
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            messageEl.textContent = randomMessage;
            
            messageEl.style.animation = 'none';
            setTimeout(() => {
                messageEl.style.animation = 'bounce 0.6s ease';
            }, 10);
        }

        // Export functions
        function importFromJSON() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (importData.tasks && Array.isArray(importData.tasks)) {
                        // Show confirmation dialog
                        const confirmMessage = `Import ${importData.tasks.length} tasks?\n\nThis will:\n‚Ä¢ Add imported tasks to your current tasks\n‚Ä¢ Keep your existing tasks\n‚Ä¢ Merge the data together\n\nContinue?`;
                        
                        if (confirm(confirmMessage)) {
                            // Find the highest current task ID to avoid conflicts
                            const maxCurrentId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) : 0;
                            
                            // Add imported tasks with new IDs
                            importData.tasks.forEach((importedTask, index) => {
                                const newTask = {
                                    ...importedTask,
                                    id: maxCurrentId + index + 1
                                };
                                tasks.push(newTask);
                            });
                            
                            // Update counters
                            currentTaskId = Math.max(currentTaskId, maxCurrentId + importData.tasks.length + 1);
                            
                            // Recalculate stats from scratch
                            recalculateStats();
                            
                            saveToStorage();
                            updateUI();
                            updateProjectTabs();
                            updateWeather();
                            updateAnimalVisitors();
                            
                            alert(`Successfully imported ${importData.tasks.length} tasks! üéâ`);
                        }
                    } else {
                        alert('Invalid file format. Please select a JSON file exported from Forest Companion.');
                    }
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid JSON file exported from Forest Companion.');
                }
                
                // Clear the file input
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }

        function recalculateStats() {
            // Recalculate all stats from current tasks
            const completedTasks = tasks.filter(task => task.completed);
            completedTasksCount = completedTasks.length;
            totalPoints = completedTasks.reduce((sum, task) => sum + (task.points || 1), 0);
            
            // Recalculate level based on total points
            level = 1;
            while (totalPoints >= getXPForLevel(level + 1)) {
                level++;
            }
            
            // Recalculate must-do streak
            updateMustDoStreak();
        }

        function exportToCSV() {
            const csvContent = [
                ['Task', 'Project', 'Priority', 'Points', 'Status', 'Created Date', 'Completed Date'],
                ...tasks.map(task => [
                    task.text,
                    task.project,
                    task.priority,
                    task.points,
                    task.completed ? 'Completed' : 'Pending',
                    new Date(task.createdAt).toLocaleDateString(),
                    task.completedAt ? new Date(task.completedAt).toLocaleDateString() : ''
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            downloadFile(csvContent, 'forest-companion-tasks.csv', 'text/csv');
        }

        function exportToJSON() {
            const exportData = {
                tasks: tasks,
                stats: {
                    level: level,
                    totalPoints: totalPoints,
                    completedTasksCount: completedTasksCount,
                    mustDoStreak: mustDoStreak
                },
                exportedAt: new Date().toISOString()
            };

            downloadFile(JSON.stringify(exportData, null, 2), 'forest-companion-tasks.json', 'application/json');
        }

        function exportToMarkdown() {
            const projects = [...new Set(tasks.map(task => task.project))].sort();
            let markdown = `# Forest Companion Tasks\n\nExported on ${new Date().toLocaleDateString()}\n\n`;
            
            markdown += `## Statistics\n- Level: ${level}\n- Total Points: ${totalPoints}\n- Tasks Completed: ${completedTasksCount}\n- Must-Do Streak: ${mustDoStreak}\n\n`;

            projects.forEach(project => {
                const projectTasks = tasks.filter(task => task.project === project);
                markdown += `## ${project}\n\n`;
                
                ['must-do', 'nice-to-do', 'stretch-goal'].forEach(priority => {
                    const priorityTasks = projectTasks.filter(task => task.priority === priority);
                    if (priorityTasks.length > 0) {
                        markdown += `### ${priority.replace('-', ' ').toUpperCase()}\n\n`;
                        priorityTasks.forEach(task => {
                            const status = task.completed ? '‚úÖ' : '‚≠ê';
                            markdown += `${status} ${task.text} (${task.points} pts)\n`;
                        });
                        markdown += '\n';
                    }
                });
            });

            downloadFile(markdown, 'forest-companion-tasks.md', 'text/markdown');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize the app
        init();

        // Click outside modal to close
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelEdit();
            }
        });
    </script>
</body>
</html>
