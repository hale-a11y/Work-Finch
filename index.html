<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woodland Work Finch for Lele+Flora</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #f5f5dc 0%, #f0f0e8 100%);
            min-height: 100vh;
            padding: 20px;
            color: #5a5a5a;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
        }

        h1 {
            color: #8b4513;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.8em;
        }

        .task-input-section {
            margin-bottom: 25px;
        }

        .task-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: white;
            margin-bottom: 15px;
        }

        .add-btn {
            width: 100%;
            padding: 15px;
            background: #8b4513;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }

        .forest-creature {
            font-size: 120px;
            transition: all 0.5s ease;
            cursor: pointer;
            user-select: none;
            margin: 30px 0;
            text-align: center;
        }

        .forest-creature:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .forest-creature.happy {
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .stats {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .stat-label {
            font-weight: 500;
            color: #8b4513;
        }

        .stat-value {
            font-weight: 600;
            color: #5a5a5a;
        }

        .tasks-container {
            flex: 1;
            overflow-y: auto;
        }

        .task-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-item:hover {
            border-color: #d4b5a0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .task-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-item:hover .task-actions {
            opacity: 1;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .edit-btn:hover {
            background: #e8e8e8;
        }

        .delete-btn:hover {
            background: #ffe6e6;
            color: #d32f2f;
        }

        .task-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d4b5a0;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-checkbox.checked {
            background: #8b4513;
            border-color: #8b4513;
        }

        .task-checkbox.checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: -2px;
            left: 3px;
            font-size: 14px;
            font-weight: bold;
        }

        .task-text {
            font-size: 16px;
            line-height: 1.4;
            color: #5a5a5a;
        }

        .section-divider {
            display: flex;
            justify-content: center;
            margin: 15px 0 10px 0;
        }

        .section-help {
            font-size: 12px;
            color: #8b4513;
            font-style: italic;
            background: rgba(212, 181, 160, 0.3);
            padding: 6px 12px;
            border-radius: 12px;
        }

        .input-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }

        .priority-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .priority-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            min-width: 90px;
            flex: 1;
        }

        .priority-btn:hover {
            background: rgba(212, 181, 160, 0.3);
        }

        .priority-btn.active {
            background: #d4b5a0;
            border-color: #8b4513;
            color: #5a5a5a;
        }

        .priority-emoji {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .priority-label {
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            line-height: 1.1;
        }

        .effort-section {
            position: relative;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #8b4513;
            font-weight: 500;
        }

        .effort-display {
            font-size: 11px;
            color: #999;
            font-weight: normal;
        }

        .points-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #e8f5e8, #fff3e0, #ffebee);
            outline: none;
            appearance: none;
            cursor: pointer;
        }

        .points-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #8b4513;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .points-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #8b4513;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 9px;
            color: #999;
        }

        .effort-tooltip {
            position: absolute;
            top: -90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .effort-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .project-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .project-tab {
            padding: 8px 16px;
            background: rgba(212, 181, 160, 0.3);
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .project-tab.active {
            background: #d4b5a0;
            color: #5a5a5a;
            border-color: #8b4513;
        }

        .project-tab:hover {
            background: rgba(212, 181, 160, 0.5);
        }

        .project-progress {
            font-size: 10px;
            position: absolute;
            top: -5px;
            right: -5px;
            background: #8b4513;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .category-inputs {
            margin-bottom: 15px;
        }

        .category-row {
            margin-bottom: 8px;
        }

        .category-input, .subcategory-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: white;
        }

        .subcategory-input {
            border-color: #e8e8e8;
            background: #fafafa;
            font-size: 13px;
        }

        .subcategory-input:focus {
            border-color: #d4b5a0;
            background: white;
            outline: none;
        }

        .weather-section {
            width: 100%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .weather-display {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .weather-text {
            font-size: 16px;
            color: #8b4513;
            font-weight: 500;
        }

        .weather-help {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }

        .buddy-container {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }

        .forest-creature {
            font-size: 120px;
            transition: all 0.5s ease;
            cursor: pointer;
            user-select: none;
            margin: 30px 0;
        }

        .animal-visitor {
            position: absolute;
            font-size: 40px;
            animation: float 3s ease-in-out infinite;
            pointer-events: none;
        }

        .visitor-1 { top: -20px; right: 20px; animation-delay: 0s; }
        .visitor-2 { top: 30px; left: -20px; animation-delay: 1s; }
        .visitor-3 { bottom: -20px; right: -10px; animation-delay: 2s; }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .visitor-help {
            font-size: 12px;
            color: #8b4513;
            margin-top: 10px;
            font-style: italic;
            text-align: center;
        }

        .weekly-summary {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            width: 100%;
        }

        .week-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .week-day {
            text-align: center;
            font-size: 12px;
            color: #8b4513;
        }

        .day-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px 0;
            font-weight: 600;
            font-size: 10px;
        }

        .day-circle.active {
            background: #8b4513;
            color: white;
        }

        .day-circle.partial {
            background: #d4b5a0;
            color: white;
        }

        .weekly-help {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
            font-style: italic;
        }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            width: 100%;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: #8b4513;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }

        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .edit-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .edit-modal h3 {
            color: #8b4513;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .edit-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b5a0;
            border-radius: 12px;
            margin-bottom: 15px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            background: white;
        }

        .edit-priority-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .edit-effort-section {
            position: relative;
            margin-bottom: 20px;
        }

        .edit-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .save-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
        }

        .save-btn {
            background: #8b4513;
            color: white;
        }

        .cancel-btn {
            background: #e8e8e8;
            color: #5a5a5a;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tasks Panel -->
        <div class="panel">
            <h1>📋 My Tasks</h1>
            
            <div class="project-tabs" id="projectTabs">
                <div class="project-tab active" onclick="filterByProject('')">
                    🌍 All Categories
                    <div class="project-progress" id="allProgress">0%</div>
                </div>
            </div>
            
            <div class="task-input-section">
                <input type="text" id="taskInput" class="task-input" placeholder="✨ What adventure shall we tackle today?" maxlength="100">
                
                <div class="section-divider">
                    <span class="section-help">🗂️ Group similar tasks together!</span>
                </div>
                
                <div class="category-inputs">
                    <div class="category-row">
                        <input type="text" id="projectInput" class="category-input" placeholder="🗂️ Category (or type your own!)" list="categoryDatalist">
                        <datalist id="categoryDatalist">
                            <option value="Admin">
                            <option value="Communication">
                            <option value="Development">
                            <option value="Meeting Prep">
                            <option value="Personal">
                            <option value="Projects">
                        </datalist>
                    </div>
                    <div class="category-row">
                        <input type="text" id="subcategoryInput" class="subcategory-input" placeholder="📂 Sub-category (optional)" list="subcategoryDatalist">
                        <datalist id="subcategoryDatalist"></datalist>
                    </div>
                </div>
                
                <div class="input-controls">
                    <div class="priority-buttons" id="priorityButtons">
                        <button type="button" class="priority-btn active" data-priority="must-do">
                            <span class="priority-emoji">🔥</span>
                            <span class="priority-label">Must-Do</span>
                        </button>
                        <button type="button" class="priority-btn" data-priority="nice-to-do">
                            <span class="priority-emoji">⭐</span>
                            <span class="priority-label">Nice-to-Do</span>
                        </button>
                        <button type="button" class="priority-btn" data-priority="stretch-goal">
                            <span class="priority-emoji">🚀</span>
                            <span class="priority-label">Stretch Goal</span>
                        </button>
                    </div>
                    
                    <div class="effort-section">
                        <div class="slider-label">
                            <span>⚡ Effort Level</span>
                            <span class="effort-display" id="effortDisplay">Quick Task</span>
                        </div>
                        <input type="range" id="pointsSlider" class="points-slider" min="1" max="10" value="1">
                        <div class="slider-markers">
                            <span>1</span><span>5</span><span>10</span>
                        </div>
                        <div class="effort-tooltip">
                            <div class="tooltip-content">
                                <strong>Time Guide:</strong><br>
                                1-2 pts: Quick (5-15 min)<br>
                                3-4 pts: Medium (30-60 min)<br>
                                5-7 pts: Big (2-4 hours)<br>
                                8-10 pts: Epic (full day+)
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="addTaskBtn" class="add-btn">🌱 Plant Your Task</button>
            </div>

            <div class="tasks-container">
                <div id="tasksList"></div>
                <div id="emptyState" class="empty-state">
                    No tasks yet! Add some tasks to help your forest companion grow! 🌱
                </div>
            </div>
        </div>

        <!-- Productivity Buddy Panel -->
        <div class="panel">
            <h1>🦊 Productivity Buddy</h1>
            
            <div class="weather-section">
                <div class="weather-display" id="weatherEmoji">☀️</div>
                <div class="weather-text" id="weatherText">Perfect productivity weather!</div>
                <div class="weather-help">🌤️ Weather changes based on your weekly completion rate</div>
            </div>
            
            <div class="buddy-container">
                <div id="forestCreature" class="forest-creature">🌰</div>
                <div style="text-align: center; font-size: 18px; font-weight: 600; color: #8b4513;" id="creatureName">Forest Seed</div>
                
                <!-- Animal visitors -->
                <div id="animalVisitors"></div>
                <div class="visitor-help" id="visitorHelp" style="display: none;">
                    🎉 Forest friends visit when you complete all must-do tasks!
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">Level:</span>
                    <span class="stat-value" id="level">1</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Points:</span>
                    <span class="stat-value" id="totalPoints">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tasks Completed:</span>
                    <span class="stat-value" id="completedCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Must-Do Streak:</span>
                    <span class="stat-value" id="mustDoStreak">0</span>
                </div>
            </div>

            <div class="weekly-summary">
                <h3 style="color: #8b4513; margin-bottom: 15px; font-size: 1.1em;">This Week</h3>
                <div class="week-progress" id="weekProgress"></div>
                <div style="font-size: 14px; color: #5a5a5a; margin-top: 10px;">
                    <strong id="weeklyMustDoComplete">0</strong> of <strong id="weeklyMustDoTotal">0</strong> must-do tasks completed
                </div>
                <div class="weekly-help">Complete 3+ tasks per day to fill the circles! 🎯</div>
            </div>

            <div class="export-section">
                <h3 style="color: #8b4513; margin-bottom: 15px; font-size: 1.2em;">Sync Your Tasks</h3>
                <button class="export-btn" onclick="exportToJSON()">💾 Export Tasks</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importFromJSON()">
                <button class="export-btn" onclick="document.getElementById('importFile').click()">📥 Import Tasks</button>
                <p style="font-size: 12px; color: #999; margin-top: 10px;">
                    Export/Import JSON to sync between devices!
                </p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal" style="display: none;">
        <div class="edit-modal-content">
            <h3>Edit Task</h3>
            <input type="text" id="editTaskText" class="edit-input" placeholder="✨ Update your adventure">
            <input type="text" id="editTaskProject" class="edit-input" placeholder="🗂️ Category" list="editCategoryDatalist">
            <datalist id="editCategoryDatalist">
                <option value="Admin">
                <option value="Communication">
                <option value="Development">
                <option value="Meeting Prep">
                <option value="Personal">
                <option value="Projects">
            </datalist>
            <input type="text" id="editTaskSubcategory" class="edit-input subcategory-input" placeholder="📂 Sub-category (optional)" list="editSubcategoryDatalist">
            <datalist id="editSubcategoryDatalist"></datalist>
            
            <div class="edit-priority-buttons" id="editPriorityButtons">
                <button type="button" class="priority-btn" data-priority="must-do">
                    <span class="priority-emoji">🔥</span>
                    <span class="priority-label">Must-Do</span>
                </button>
                <button type="button" class="priority-btn" data-priority="nice-to-do">
                    <span class="priority-emoji">⭐</span>
                    <span class="priority-label">Nice-to-Do</span>
                </button>
                <button type="button" class="priority-btn" data-priority="stretch-goal">
                    <span class="priority-emoji">🚀</span>
                    <span class="priority-label">Stretch Goal</span>
                </button>
            </div>

            <div class="edit-effort-section">
                <div class="slider-label">
                    <span>⚡ Effort Level</span>
                    <span class="effort-display" id="editEffortDisplay">Quick Task</span>
                </div>
                <input type="range" id="editPointsSlider" class="points-slider" min="1" max="10" value="1">
                <div class="slider-markers">
                    <span>1</span><span>5</span><span>10</span>
                </div>
            </div>
            
            <div class="edit-modal-actions">
                <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
                <button class="save-btn" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Basic state with localStorage persistence
        let tasks = JSON.parse(localStorage.getItem('forestTasks')) || [];
        let currentTaskId = parseInt(localStorage.getItem('currentTaskId')) || 1;
        let completedTasksCount = 0;
        let categorySubcategories = JSON.parse(localStorage.getItem('categorySubcategories')) || {};
        let currentProjectFilter = '';
        let totalPoints = parseInt(localStorage.getItem('totalPoints')) || 0;
        let mustDoStreak = parseInt(localStorage.getItem('mustDoStreak')) || 0;
        let level = parseInt(localStorage.getItem('level')) || 1;
        let editingTaskId = null;

        function saveToStorage() {
            localStorage.setItem('forestTasks', JSON.stringify(tasks));
            localStorage.setItem('currentTaskId', currentTaskId.toString());
            localStorage.setItem('categorySubcategories', JSON.stringify(categorySubcategories));
            localStorage.setItem('totalPoints', totalPoints.toString());
            localStorage.setItem('mustDoStreak', mustDoStreak.toString());
            localStorage.setItem('level', level.toString());
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            document.getElementById('editModal').style.display = 'flex';
            
            // Populate fields
            document.getElementById('editTaskText').value = task.text;
            
            const projectParts = task.project.split(' > ');
            document.getElementById('editTaskProject').value = projectParts[0] || '';
            document.getElementById('editTaskSubcategory').value = projectParts[1] || '';
            
            // Update subcategory suggestions for edit modal
            const editProjectParts = task.project.split(' > ');
            updateEditSubcategorySuggestions(editProjectParts[0] || '');
            
            // Set priority buttons
            document.querySelectorAll('#editPriorityButtons .priority-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.priority === task.priority) {
                    btn.classList.add('active');
                }
            });
            
            // Set points slider
            document.getElementById('editPointsSlider').value = task.points;
            updateEditEffortDisplay(task.points);
        }

        function saveEdit() {
            const task = tasks.find(t => t.id === editingTaskId);
            if (!task) return;

            const newText = document.getElementById('editTaskText').value.trim();
            let newProject = document.getElementById('editTaskProject').value.trim() || 'General';
            const newSubcategory = document.getElementById('editTaskSubcategory').value.trim();
            
            if (newSubcategory) {
                learnCategorySubcategory(newProject, newSubcategory);
                newProject = `${newProject} > ${newSubcategory}`;
            }
            
            const activeEditBtn = document.querySelector('#editPriorityButtons .priority-btn.active');
            const newPriority = activeEditBtn ? activeEditBtn.dataset.priority : 'must-do';
            const newPoints = parseInt(document.getElementById('editPointsSlider').value) || 1;

            if (!newText) return;

            // Update points if task is completed
            if (task.completed) {
                totalPoints = totalPoints - task.points + newPoints;
            }

            task.text = newText;
            task.project = newProject;
            task.priority = newPriority;
            task.points = newPoints;

            cancelEdit();
            saveToStorage();
            updateTasksList();
            updateStats();
            updateProjectTabs();
        }

        function cancelEdit() {
            document.getElementById('editModal').style.display = 'none';
            editingTaskId = null;
        }

        function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = tasks[taskIndex];
            if (task.completed) {
                totalPoints = Math.max(0, totalPoints - task.points);
                level = Math.max(1, Math.floor(totalPoints / 25) + 1);
                updateMustDoStreak();
            }

            tasks.splice(taskIndex, 1);
            saveToStorage();
            saveToStorage();
            saveToStorage();
            updateTasksList();
            updateStats();
            updateProjectTabs();
            updateWeather();
            updateAnimalVisitors();
            updateWeeklyProgress();
            updateBuddy();
        }

        function updateEditEffortDisplay(value) {
            const effortLevels = {
                1: 'Quick Task', 2: 'Quick Task', 3: 'Medium Task', 4: 'Medium Task',
                5: 'Big Task', 6: 'Big Task', 7: 'Big Task', 8: 'Major Project',
                9: 'Major Project', 10: 'Epic Quest'
            };
            document.getElementById('editEffortDisplay').textContent = effortLevels[value] || 'Quick Task';
        }

        function exportToJSON() {
            const exportData = {
                tasks: tasks,
                categorySubcategories: categorySubcategories,
                stats: {
                    level: level,
                    totalPoints: totalPoints,
                    mustDoStreak: mustDoStreak,
                    currentTaskId: currentTaskId
                },
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'woodland-finch-tasks.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFromJSON() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (importData.tasks && Array.isArray(importData.tasks)) {
                        const confirmMessage = `Import ${importData.tasks.length} tasks? This will add them to your current tasks.`;
                        
                        if (confirm(confirmMessage)) {
                            const maxCurrentId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) : 0;
                            
                            importData.tasks.forEach((importedTask, index) => {
                                const newTask = {
                                    ...importedTask,
                                    id: maxCurrentId + index + 1
                                };
                                tasks.push(newTask);
                            });
                            
                            currentTaskId = Math.max(currentTaskId, maxCurrentId + importData.tasks.length + 1);
                            
                            if (importData.categorySubcategories) {
                                Object.assign(categorySubcategories, importData.categorySubcategories);
                            }
                            
                            // Recalculate stats
                            const completedTasks = tasks.filter(task => task.completed);
                            totalPoints = completedTasks.reduce((sum, task) => sum + (task.points || 1), 0);
                            level = Math.max(1, Math.floor(totalPoints / 25) + 1);
                            updateMustDoStreak();
                            
                            saveToStorage();
                            updateTasksList();
                            updateStats();
                            updateProjectTabs();
                            updateWeather();
                            updateAnimalVisitors();
                            updateWeeklyProgress();
                            updateBuddy();
                            
                            alert(`Successfully imported ${importData.tasks.length} tasks! 🎉`);
                        }
                    } else {
                        alert('Invalid file format. Please select a JSON file exported from Woodland Work Finch.');
                    }
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid JSON file.');
                }
                
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }

        // Forest creature evolution stages
        const creatureStages = [
            { emoji: '🌰', name: 'Forest Seed', minLevel: 1 },
            { emoji: '🦊', name: 'Fox Kit', minLevel: 3 },
            { emoji: '🐺', name: 'Young Wolf', minLevel: 6 },
            { emoji: '🦌', name: 'Forest Deer', minLevel: 10 },
            { emoji: '🧚‍♀️', name: 'Forest Guardian', minLevel: 15 },
            { emoji: '👑🌲', name: 'Forest Ruler', minLevel: 25 }
        ];

        // Weather patterns - improved messages
        const weatherPatterns = [
            { emoji: '☀️', text: 'Perfect productivity weather!' },
            { emoji: '⛅', text: 'Partly cloudy but getting things done!' },
            { emoji: '🌧️', text: 'Rainy day - time to focus indoors' },
            { emoji: '🌫️', text: 'Cloudy productivity day' },
            { emoji: '🌈', text: 'Rainbow after the storm - great work!' }
        ];

        // Animal visitors
        const animalVisitors = ['🦋', '🐿️', '🦉', '🐰', '🦔', '🦝', '🐻'];

        function addTask() {
            const taskInput = document.getElementById('taskInput');
            const taskText = taskInput.value.trim();
            
            if (!taskText) return;

            // Get project and subcategory
            let project = document.getElementById('projectInput').value.trim() || 'General';
            const subcategory = document.getElementById('subcategoryInput').value.trim();
            
            // Learn category-subcategory relationship
            if (subcategory) {
                learnCategorySubcategory(project, subcategory);
                project = `${project} > ${subcategory}`;
            }

            // Get selected priority
            const activePriorityBtn = document.querySelector('.priority-btn.active');
            const priority = activePriorityBtn ? activePriorityBtn.dataset.priority : 'must-do';
            
            // Get effort points
            const points = parseInt(document.getElementById('pointsSlider').value) || 1;

            const task = {
                id: currentTaskId++,
                text: taskText,
                project: project,
                priority: priority,
                points: points,
                completed: false,
                createdAt: new Date().toISOString()
            };

            tasks.push(task);
            taskInput.value = '';
            document.getElementById('projectInput').value = '';
            document.getElementById('subcategoryInput').value = '';
            
            // Reset to defaults
            document.getElementById('pointsSlider').value = 1;
            updateEffortDisplay(1);
            
            // Reset priority to must-do
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.priority === 'must-do') {
                    btn.classList.add('active');
                }
            });
            
            updateTasksList();
            updateStats();
            updateProjectTabs();
            updateWeather();
            updateAnimalVisitors();
            updateWeeklyProgress();
        }

        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const wasCompleted = task.completed;
            task.completed = !task.completed;

            if (!wasCompleted && task.completed) {
                // Task completed
                totalPoints += task.points;
                
                // Check for level up
                const newLevel = Math.floor(totalPoints / 25) + 1;
                if (newLevel > level) {
                    level = newLevel;
                    updateBuddy();
                }
                
                // Update must-do streak
                if (task.priority === 'must-do') {
                    updateMustDoStreak();
                }
                
                animateCreature();
            } else if (wasCompleted && !task.completed) {
                // Task uncompleted
                totalPoints = Math.max(0, totalPoints - task.points);
                level = Math.max(1, Math.floor(totalPoints / 25) + 1);
                updateMustDoStreak();
            }
            
            updateTasksList();
            updateStats();
            updateProjectTabs();
            updateWeather();
            updateAnimalVisitors();
            updateWeeklyProgress();
            updateBuddy();
        }

        function updateMustDoStreak() {
            const thisWeekStart = getWeekStart();
            const thisWeekMustDos = tasks.filter(task => {
                return task.priority === 'must-do' && 
                       new Date(task.createdAt) >= thisWeekStart;
            });
            
            const completedMustDos = thisWeekMustDos.filter(task => task.completed);
            
            if (thisWeekMustDos.length === 0) {
                mustDoStreak = 0;
            } else if (completedMustDos.length === thisWeekMustDos.length) {
                mustDoStreak++;
            } else {
                mustDoStreak = 0;
            }
        }

        function getWeekStart() {
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        function updateWeather() {
            const thisWeekStart = getWeekStart();
            const thisWeekTasks = tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                return taskDate >= thisWeekStart;
            });

            const completedThisWeek = thisWeekTasks.filter(task => task.completed).length;
            const totalThisWeek = thisWeekTasks.length;
            
            let weatherIndex;
            if (totalThisWeek === 0) {
                weatherIndex = 1; // Partly cloudy
            } else {
                const completionRate = completedThisWeek / totalThisWeek;
                if (completionRate >= 0.9) weatherIndex = 4; // Rainbow
                else if (completionRate >= 0.7) weatherIndex = 0; // Sunny
                else if (completionRate >= 0.4) weatherIndex = 1; // Partly cloudy
                else if (completionRate >= 0.2) weatherIndex = 2; // Rainy
                else weatherIndex = 3; // Cloudy
            }

            const weather = weatherPatterns[weatherIndex];
            document.getElementById('weatherEmoji').textContent = weather.emoji;
            document.getElementById('weatherText').textContent = weather.text;
        }

        function updateAnimalVisitors() {
            const thisWeekStart = getWeekStart();
            const mustDoTasks = tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                return task.priority === 'must-do' && taskDate >= thisWeekStart;
            });
            
            const completedMustDos = mustDoTasks.filter(task => task.completed);
            const visitorsContainer = document.getElementById('animalVisitors');
            const visitorHelp = document.getElementById('visitorHelp');
            
            if (mustDoTasks.length > 0 && completedMustDos.length === mustDoTasks.length) {
                // All must-dos completed - show visitors!
                const numVisitors = Math.min(3, Math.floor(completedMustDos.length / 2) + 1);
                visitorsContainer.innerHTML = '';
                
                for (let i = 0; i < numVisitors; i++) {
                    const visitor = document.createElement('div');
                    visitor.className = `animal-visitor visitor-${i + 1}`;
                    visitor.textContent = animalVisitors[Math.floor(Math.random() * animalVisitors.length)];
                    visitorsContainer.appendChild(visitor);
                }
                
                visitorHelp.style.display = 'block';
                visitorHelp.textContent = '🎉 Amazing! You completed all must-do tasks this week!';
            } else if (mustDoTasks.length > 0) {
                visitorsContainer.innerHTML = '';
                visitorHelp.style.display = 'block';
                visitorHelp.textContent = `🎯 Complete ${mustDoTasks.length - completedMustDos.length} more must-do tasks for forest visitors!`;
            } else {
                visitorsContainer.innerHTML = '';
                visitorHelp.style.display = 'none';
            }
        }

        function updateWeeklyProgress() {
            const weekProgress = document.getElementById('weekProgress');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const thisWeekStart = getWeekStart();
            
            weekProgress.innerHTML = '';
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(thisWeekStart);
                dayDate.setDate(thisWeekStart.getDate() + i);
                
                const dayTasks = tasks.filter(task => {
                    const taskDate = new Date(task.createdAt);
                    return taskDate.toDateString() === dayDate.toDateString() && task.completed;
                });
                
                const dayElement = document.createElement('div');
                dayElement.className = 'week-day';
                dayElement.innerHTML = `
                    <div>${days[i]}</div>
                    <div class="day-circle ${dayTasks.length >= 3 ? 'active' : dayTasks.length > 0 ? 'partial' : ''}">${dayTasks.length}</div>
                `;
                weekProgress.appendChild(dayElement);
            }
            
            // Update must-do progress
            const thisWeekMustDos = tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                return task.priority === 'must-do' && taskDate >= thisWeekStart;
            });
            const completedMustDos = thisWeekMustDos.filter(task => task.completed);
            
            document.getElementById('weeklyMustDoComplete').textContent = completedMustDos.length;
            document.getElementById('weeklyMustDoTotal').textContent = thisWeekMustDos.length;
        }

        function updateBuddy() {
            const forestCreature = document.getElementById('forestCreature');
            const creatureName = document.getElementById('creatureName');
            
            // Find current stage
            let currentStage = creatureStages[0];
            for (let i = creatureStages.length - 1; i >= 0; i--) {
                if (level >= creatureStages[i].minLevel) {
                    currentStage = creatureStages[i];
                    break;
                }
            }
            
            forestCreature.textContent = currentStage.emoji;
            creatureName.textContent = currentStage.name;
        }

        function learnCategorySubcategory(category, subcategory) {
            if (!category || !subcategory) return;
            
            if (!categorySubcategories[category]) {
                categorySubcategories[category] = [];
            }
            
            if (!categorySubcategories[category].includes(subcategory)) {
                categorySubcategories[category].push(subcategory);
                categorySubcategories[category].sort();
            }
        }

        function updateEditSubcategorySuggestions(category) {
            const datalist = document.getElementById('editSubcategoryDatalist');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            
            if (category && categorySubcategories[category]) {
                categorySubcategories[category].forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    datalist.appendChild(option);
                });
            }
        }

        function updateSubcategorySuggestions(category) {
            const datalist = document.getElementById('subcategoryDatalist');
            datalist.innerHTML = '';
            
            if (category && categorySubcategories[category]) {
                categorySubcategories[category].forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    datalist.appendChild(option);
                });
            }
        }

        function filterByProject(project) {
            currentProjectFilter = project;
            updateTasksList();
            
            // Update active tab
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function updateProjectTabs() {
            const projectTabs = document.getElementById('projectTabs');
            const projects = [...new Set(tasks.map(task => task.project))].sort();
            
            // Clear existing tabs except "All Categories"
            projectTabs.innerHTML = `
                <div class="project-tab ${currentProjectFilter === '' ? 'active' : ''}" onclick="filterByProject('')">
                    🌍 All Categories
                    <div class="project-progress" id="allProgress">0%</div>
                </div>
            `;
            
            projects.forEach(project => {
                const projectTasks = tasks.filter(task => task.project === project);
                const completedTasks = projectTasks.filter(task => task.completed);
                const progressPercent = projectTasks.length > 0 ? Math.round((completedTasks.length / projectTasks.length) * 100) : 0;
                
                const tab = document.createElement('div');
                tab.className = `project-tab ${currentProjectFilter === project ? 'active' : ''}`;
                tab.onclick = () => filterByProject(project);
                tab.innerHTML = `
                    ${project}
                    <div class="project-progress">${progressPercent}%</div>
                `;
                projectTabs.appendChild(tab);
            });
            
            // Update all categories progress
            const allCompleted = tasks.filter(task => task.completed).length;
            const allProgress = tasks.length > 0 ? Math.round((allCompleted / tasks.length) * 100) : 0;
            document.getElementById('allProgress').textContent = allProgress + '%';
        }

        function updateTasksList() {
            const tasksList = document.getElementById('tasksList');
            const emptyState = document.getElementById('emptyState');
            
            const filteredTasks = currentProjectFilter ? 
                tasks.filter(task => task.project === currentProjectFilter) : 
                tasks;
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            tasksList.innerHTML = filteredTasks.map(task => `
                <div class="task-item">
                    <div class="task-content">
                        <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                             onclick="toggleTask(${task.id})"></div>
                        <div>
                            <div class="task-text">${task.text}</div>
                            <div style="margin-top: 5px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <span style="background: #d4b5a0; padding: 2px 8px; border-radius: 12px; font-size: 10px; color: #5a5a5a;">${task.project}</span>
                                <span style="background: #e8f5e8; padding: 2px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32;">${task.priority.replace('-', ' ')}</span>
                                <span style="background: #fff3e0; padding: 2px 8px; border-radius: 12px; font-size: 10px; color: #f57c00;">${task.points} pts</span>
                            </div>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="edit-btn" onclick="editTask(${task.id})">✏️</button>
                        <button class="delete-btn" onclick="deleteTask(${task.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('level').textContent = level;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('completedCount').textContent = tasks.filter(t => t.completed).length;
            document.getElementById('mustDoStreak').textContent = mustDoStreak;
        }

        function updateEffortDisplay(value) {
            const effortLevels = {
                1: 'Quick Task', 2: 'Quick Task', 3: 'Medium Task', 4: 'Medium Task',
                5: 'Big Task', 6: 'Big Task', 7: 'Big Task', 8: 'Major Project',
                9: 'Major Project', 10: 'Epic Quest'
            };
            document.getElementById('effortDisplay').textContent = effortLevels[value] || 'Quick Task';
        }

        function animateCreature() {
            const creature = document.getElementById('forestCreature');
            creature.classList.add('happy');
            setTimeout(() => creature.classList.remove('happy'), 600);
        }

        // Initialize
        document.getElementById('addTaskBtn').addEventListener('click', addTask);
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });
        document.getElementById('forestCreature').addEventListener('click', animateCreature);

        // Category input handler
        document.getElementById('projectInput').addEventListener('input', function() {
            updateSubcategorySuggestions(this.value);
        });

        // Edit modal category input handler
        document.addEventListener('input', function(e) {
            if (e.target.id === 'editTaskProject') {
                updateEditSubcategorySuggestions(e.target.value);
            }
        });

        // Priority button handlers
        document.querySelectorAll('.priority-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Points slider handler
        document.getElementById('pointsSlider').addEventListener('input', function() {
            updateEffortDisplay(parseInt(this.value));
        });

        // Edit modal priority button handlers
        document.addEventListener('click', function(e) {
            if (e.target.closest('#editPriorityButtons .priority-btn')) {
                const btn = e.target.closest('.priority-btn');
                document.querySelectorAll('#editPriorityButtons .priority-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        });

        // Edit modal points slider handler
        document.addEventListener('input', function(e) {
            if (e.target.id === 'editPointsSlider') {
                updateEditEffortDisplay(parseInt(e.target.value));
            }
        });

        // Click outside modal to close
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelEdit();
            }
        });

        // Initial load
        saveToStorage();
        updateTasksList();
        updateProjectTabs();
        updateWeather();
        updateAnimalVisitors();
        updateWeeklyProgress();
    </script>
</body>
</html>
